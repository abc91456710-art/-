import folium
import numpy as np
from folium import LayerControl, TileLayer
from folium.plugins import LocateControl
from IPython.display import display, HTML, Javascript
import math # Í∞ÅÎèÑ Í≥ÑÏÇ∞ÏùÑ ÏúÑÌï¥ ÌïÑÏöî
#ÎèÑÎ°úÎßù Ï§ÄÏàò

# ====================================================================
# A. Îç∞Ïù¥ÌÑ∞ Î∞è RRI Í≥ÑÏÇ∞ Î°úÏßÅ (Î≥ÄÏàò Ï†ïÏùò)
# ====================================================================

# Pyeongchon City Hall Station (ÏïàÏñëÏãúÏ≤≠Ïó≠) Ï£ºÎ≥Ä Ï¢åÌëú
nodes = {
    "start": { "lat": 37.39361271,"lon": 126.9496219,"node_id": 1},
    "1.0": {"lat": 37.39275655,"lon": 126.950075, "node_id": 0},
    "2.0": { "lat": 37.39266633, "lon": 126.9501337, "node_id": 2 },
    "3.0": { "lat": 37.3925479, "lon": 126.9502075, "node_id": 228 },
    "4.0": { "lat": 37.39177726, "lon": 126.9506273, "node_id": 212 },
    "5.0": { "lat": 37.39171648, "lon": 126.9506599, "node_id": 213 },
     "6.0": { "lat": 37.39165506, "lon": 126.9506929, "node_id": 229 },
    "7.0": { "lat":37.39128268, "lon": 126.9508966, "node_id": 208 },
    "8.0": { "lat": 37.39110633, "lon": 126.9509935, "node_id": 209 },
    "9.0": { "lat": 37.39116633, "lon": 126.9511695, "node_id": 222 },
    "10.0": { "lat":37.39146484, "lon": 126.952038, "node_id": 218 },
    "11.0": { "lat": 37.39148972, "lon": 126.9521094, "node_id": 217 },
    "12.0": { "lat":37.39151624, "lon": 126.9521855, "node_id": 220 },
    "13.0": { "lat": 37.39150342, "lon": 126.9521924, "node_id": 238 },
    "14.0": { "lat": 37.39132803, "lon": 126.952286, "node_id": 189 },
    "15.0": { "lat": 37.39112856, "lon": 126.9523935, "node_id": 190 },
    "16.0": { "lat": 37.39091194, "lon": 126.9525129, "node_id": 187 },
    "17.0": { "lat": 37.39148972, "lon": 126.9521094, "node_id": 217 },
    "pickup1": { "lat": 37.3908509, "lon": 126.9525469, "node_id": 188 },
    "pickup2": { "lat": 37.3908509, "lon": 126.9525469, "node_id": 188 },
    "20.0": { "lat": 37.39091194, "lon": 126.9525129, "node_id": 187 },
    "21.0": { "lat": 37.39112856, "lon": 126.9523935, "node_id": 190 },
     "22.0": { "lat": 37.39132803, "lon": 126.952286, "node_id": 189 },
    "23.0": { "lat": 37.39150342, "lon": 126.9521924, "node_id": 238 },
    "24.0": { "lat":37.39151624, "lon": 126.9521855, "node_id": 220 },
    "25.0": { "lat": 37.39148972, "lon": 126.9521094, "node_id": 217 },
    "26.0": { "lat":37.39146484, "lon": 126.952038, "node_id": 218 },
    "27.0": { "lat": 37.39116633, "lon": 126.9511695, "node_id": 222 },
    "28.0": { "lat": 37.39110633, "lon": 126.9509935, "node_id": 209 },
    "19.0": { "lat":37.3910926, "lon":126.9510007, "node_id": 226 },
    "30.0": { "lat": 37.39091788, "lon": 126.9510924, "node_id": 227 },
    "31.0": { "lat": 37.39051253, "lon": 126.9513135, "node_id": 214 },
     "32.0": { "lat": 37.39044088, "lon": 126.9513615, "node_id": 207 },
    "33.0": { "lat": 37.39038125, "lon": 126.9514014, "node_id": 37 },
    "34.0": { "lat": 37.38973272, "lon": 126.9517562, "node_id": 36 },
    "35.0": { "lat": 37.38969394, "lon": 126.9517651, "node_id": 73 },
    "36.0": { "lat": 37.38963557, "lon": 126.9517766, "node_id": 84 },
    "37.0": { "lat": 37.38919807, "lon": 126.9520052, "node_id": 78 },
    "38.0": { "lat": 37.38910942, "lon": 126.9520539, "node_id": 79 },
    "39.0": { "lat": 37.38902396, "lon": 126.9521008, "node_id": 83 },
    "40.0": { "lat": 37.38781798, "lon": 126.9527802, "node_id": 360 },
    "41.0": { "lat": 37.38798769, "lon": 126.9532906, "node_id": 361 },
    "42.0": { "lat": 37.38810045, "lon": 126.953613, "node_id": 363 },
    "43.0": { "lat": 37.3882029, "lon": 126.9538975, "node_id": 364 },
    "44.0": { "lat": 37.38864188, "lon": 126.9536788, "node_id": 366 },
    "45.0": { "lat": 37.38889413, "lon": 126.9535439, "node_id": 368 },
    "46.0": { "lat": 37.38875024, "lon": 126.9530505, "node_id": 369 },
    "deliver1": { "lat": 37.38885545, "lon": 126.9528343, "node_id": 373 },
    "48.0": { "lat": 37.38875024, "lon": 126.9530505, "node_id": 369 },
    "49.0": { "lat": 37.38889413, "lon": 126.9535439, "node_id": 368 },
    "50.0": { "lat": 37.38864188, "lon": 126.9536788, "node_id": 366 },
    "51.0": { "lat": 37.3882029, "lon": 126.9538975, "node_id": 364 },
    "52.0": { "lat": 37.38810045, "lon": 126.953613, "node_id": 363 },
    "53.0": { "lat": 37.38798769, "lon": 126.9532906, "node_id": 361 },
    "54.0": { "lat": 37.38781798, "lon": 126.9527802, "node_id": 360 },
    "55.0": { "lat": 37.38654868, "lon": 126.9534427, "node_id": 82 },
    "56.0": { "lat": 37.38641883, "lon": 126.9535138, "node_id": 75 },
    "57.0": { "lat": 37.38646296, "lon": 126.9536444, "node_id": 74 },
    "58.0": { "lat": 37.38689169, "lon": 126.9548977, "node_id": 32 },
    "59.0": { "lat": 37.38713387, "lon": 126.9556019, "node_id": 31 },
    "60.0": { "lat": 37.38775445, "lon": 126.9574067, "node_id": 69 },
    "61.0": { "lat":37.38784553, "lon":126.95766162, "node_id": 70 },
    "62.0": { "lat": 37.38785405, "lon": 126.9576854, "node_id": 71 },
    "63.0": { "lat":37.38795377, "lon": 126.9576317, "node_id": 5 },
    "64.0": { "lat": 37.39045366, "lon": 126.9562593, "node_id": 6 },
    "65.0": { "lat": 37.39054834, "lon":126.9562069, "node_id": 131 },
    "66.0": { "lat": 37.39053464, "lon": 126.9562145, "node_id": 132 },
    "67.0": { "lat": 37.39065826, "lon": 126.9564814, "node_id": 150 },
    "68.0": { "lat": 37.39108559, "lon": 126.9577205, "node_id": 151 },
    "69.0": { "lat": 37.39115277, "lon": 126.9579609, "node_id": 140 },
    "70.0": { "lat": 37.39116932, "lon": 126.9580257, "node_id": 141 },
    "71.0": { "lat": 37.39118388, "lon": 126.9580916, "node_id": 169 },                                      
    "72.0": { "lat": 37.39118758, "lon": 126.9581083, "node_id": 171 },
    "73.0": { "lat": 37.39149538, "lon": 126.9590011, "node_id": 170 },
    "74.0": { "lat": 37.39150422, "lon": 126.9590186, "node_id": 142 },
    "75.0": { "lat": 37.39153593, "lon": 126.9590814, "node_id": 143 },
    "76.0": { "lat": 37.39156401, "lon": 126.9591477, "node_id": 44 },
     "77.0": { "lat": 37.39189462, "lon": 126.9601269, "node_id": 45 },
     "78.0": { "lat": 37.39201619, "lon": 126.9604848, "node_id": 92 },
     "79.0": { "lat": 37.39209954, "lon": 126.9607199, "node_id": 93 },
     "80.0": { "lat": 37.39217356, "lon": 126.9609299, "node_id": 119 },
     "81.0": { "lat": 37.39250347, "lon": 126.9619201, "node_id": 110 },
     "82.0": { "lat": 37.39252202, "lon": 126.9619781, "node_id": 111 },
     "83.0": { "lat": 37.3925703, "lon": 126.9621178, "node_id": 123 },
     "84.0": { "lat": 37.39313855, "lon": 126.9637185, "node_id": 97 },
     "85.0": { "lat": 37.39317795, "lon": 126.9638338, "node_id": 98 },
     "86.0": { "lat": 37.39327583, "lon": 126.963777, "node_id": 108 },
     "pickup3": { "lat": 37.39372317, "lon":126.9635231, "node_id": 100 },
     "pickup4": { "lat": 37.39372317, "lon":126.9635231, "node_id": 100 },
     "pickup5": { "lat": 37.39372317, "lon": 126.9635231, "node_id": 100 },
     "90.0": { "lat": 37.39327583, "lon": 126.963777, "node_id": 108 },
    "91.0": { "lat": 37.39317795, "lon": 126.9638338, "node_id": 98 },
    "92.0": { "lat": 37.39282826, "lon":126.9642116, "node_id": 428 },
    "93.0": { "lat": 37.39237917, "lon": 126.9644367, "node_id": 424 },
    "94.0": { "lat": 37.3920058, "lon": 126.9646295, "node_id": 418 },
    "95.0": { "lat": 37.39147674, "lon": 126.9650643, "node_id": 415 },
    "deliver2": { "lat": 37.39160504, "lon": 126.9654754, "node_id": 417 },
    "97.0": { "lat": 37.39147674, "lon": 126.9650643, "node_id": 415 },
    "98.0": { "lat": 37.39090654, "lon": 126.9653472, "node_id": 411 },
     "99.0": { "lat": 37.39050686, "lon": 126.9653916, "node_id": 410 },
     "100.0": { "lat": 37.3908945, "lon": 126.9665165, "node_id": 87 },
     "101.0": { "lat": 37.39093996, "lon": 126.9666485, "node_id": 86 },
     "102.0": { "lat": 37.39111957, "lon":126.9665466, "node_id": 85 },
     "103.0": { "lat": 37.3934561, "lon": 126.9652297, "node_id": 89 },
     "104.0": { "lat": 37.39361267, "lon": 126.9651431, "node_id": 88 },
     "105.0": { "lat": 37.39362392, "lon": 126.9651369, "node_id": 43 },
    "106.0": { "lat": 37.39376415, "lon": 126.9650583, "node_id": 41 },
    "107.0": { "lat": 37.39489174, "lon": 126.9644121, "node_id": 40 },
    "108.0": { "lat": 37.39536263, "lon": 126.9641512, "node_id": 58 },
    "109.0": { "lat": 37.39556223, "lon": 126.9640496, "node_id": 243 },
    "110.0": { "lat": 37.39575679, "lon": 126.9639421, "node_id": 259 },
    "111.0": { "lat": 37.39610134, "lon": 126.9637134, "node_id": 271 },
    "112.0": { "lat": 37.39618649, "lon": 126.9636501, "node_id": 258 },
    "113.0": { "lat": 37.39622617, "lon": 126.9636205, "node_id": 257 },
    "114.0": { "lat": 37.39696841, "lon": 126.9631221, "node_id": 272 },
    "115.0": { "lat": 37.39709774, "lon": 126.9630361, "node_id": 252 },
    "116.0": { "lat": 37.3970487, "lon":126.9628817, "node_id": 251 },
    "117.0": { "lat": 37.39666272, "lon": 126.9617052, "node_id": 274 },
    "118.0": { "lat": 37.3966195, "lon": 126.9615842, "node_id": 245 },
    "119.0": { "lat": 37.39656548, "lon": 126.9614312, "node_id": 263 },
    "120.0": { "lat":37.39611171, "lon":126.9601588, "node_id": 64 },
    "121.0": { "lat":37.39652697, "lon":126.9598812, "node_id": 342 },
    "122.0": { "lat":37.39675237, "lon":126.9594042, "node_id": 343 },
    "123.0": { "lat":37.39720648, "lon":126.9591727, "node_id": 344 },
     "deliver3": { "lat":37.39710447, "lon":126.9595379, "node_id": 354 },
      "125.0": { "lat":37.39720648, "lon":126.9591727, "node_id": 344 },
      "126.0": { "lat":37.39793779, "lon":126.9587364, "node_id": 345},
      "127.0": { "lat":37.39827084, "lon":126.9585755, "node_id": 346 },
      "128.0": { "lat":37.39865816, "lon":126.9583953, "node_id": 444 },
      "129.0": { "lat":37.39839446, "lon":126.9575885, "node_id": 289 },
      "130.0": { "lat":37.39831235, "lon":126.9573561, "node_id": 286 },
      "131.0": { "lat":37.39822686, "lon":126.9571132, "node_id": 285 },
      "132.0": { "lat":37.39793068, "lon":126.95635937, "node_id": 431 },
      "133.0": { "lat":37.39775849, "lon":126.9557528, "node_id": 430 },
      "134.0": { "lat":37.39775849, "lon":126.95575287, "node_id": 287 },
      "135.0": { "lat":37.39754104, "lon":126.9551193, "node_id": 66 },
      "136.0": { "lat":37.39738655, "lon":126.9546729, "node_id": 326 },
      "137.0": { "lat":37.39718128, "lon":126.9547895, "node_id": 327 },
      "138.0": { "lat":37.39683333, "lon":126.9550076, "node_id": 329 },
     "139.0": { "lat": 37.39626839, "lon": 126.9553286, "node_id": 335 },
    "140.0": { "lat": 37.39575642, "lon":126.9550724, "node_id": 340 },
    "deliver4": { "lat": 37.39556132, "lon":126.9544399, "node_id": 341 },
    "142.0": { "lat": 37.39575642, "lon":126.9550724, "node_id": 340 },
    "143.0": { "lat": 37.39626839, "lon": 126.9553286, "node_id": 335 },
    "144.0": { "lat":37.39683333, "lon":126.9550076, "node_id": 329 },
     "145.0": { "lat":37.39718128, "lon":126.9547895, "node_id": 327 },
    "146.0": { "lat":37.39738655, "lon":126.9546729, "node_id": 326 },
     "147.0": { "lat":37.39754104, "lon":126.9551193, "node_id": 66 },
 "148.0": { "lat":37.3968558, "lon":126.9531237, "node_id": 65 },
     "149.0": { "lat":37.39676154, "lon":126.9528528, "node_id": 293 },
     "150.0": { "lat":37.39664477, "lon":126.952916, "node_id": 290 },
    "151.0": { "lat": 37.39529617, "lon": 126.9536461, "node_id": 28 },
      "152.0": { "lat": 37.39419858, "lon": 126.9542436, "node_id": 27 },
     "153.0": { "lat": 37.39409189, "lon": 126.9543046, "node_id": 178 },
 "154.0": { "lat": 37.39408633, "lon": 126.9542892, "node_id": 236 },
     "155.0": { "lat":37.39398964, "lon": 126.9540227, "node_id": 197 },
     "156.0": { "lat": 37.39383046, "lon": 126.9535247, "node_id": 184 },
     "157.0": { "lat": 37.39339247, "lon": 126.9522525, "node_id": 185 },
     "158.0": { "lat": 37.39321111, "lon": 126.9517315, "node_id": 186 },
     "159.0": { "lat": 37.39272928, "lon": 126.9503094, "node_id": 175 },
    "160.0": { "lat": 37.39266633, "lon": 126.9501337, "node_id": 2 },
       "161.0": {"lat": 37.39275655,"lon": 126.950075, "node_id": 0},
      "162": { "lat": 37.39361271,"lon": 126.9496219,"node_id": 1},
      "163": { "lat": 37.39486358,"lon": 126.9489419,"node_id": 295},
      "164": { "lat": 37.39515569,"lon": 126.9487692,"node_id": 296},
      "165": { "lat": 37.39528057,"lon": 126.9486858,"node_id": 297},
      "166": { "lat": 37.39534546,"lon": 126.948807,"node_id": 298},
      "167": { "lat": 37.39571059,"lon": 126.9498001,"node_id": 3},
      "168": { "lat": 37.39582225,"lon": 126.9501238,"node_id": 4},
     "169.0": { "lat": 37.39628045, "lon": 126.9514568, "node_id": 294 },
    "170.0": { "lat": 37.39590735, "lon": 126.9516198, "node_id": 305 },
    "171.0": { "lat": 37.39578618, "lon": 126.9516651, "node_id": 310 },
    "172.0": { "lat": 37.39566767, "lon": 126.9517357, "node_id": 311 },
    "173.0": { "lat": 37.39554407, "lon": 126.9518031, "node_id": 312 },
    "deliver5": { "lat": 37.39535172, "lon":126.9523116, "node_id": 309 },
    "175.0": { "lat": 37.39554407, "lon": 126.9518031, "node_id": 312 },
    "176.0": { "lat": 37.39566767, "lon":  126.9517357, "node_id": 311 },
    "177.0": { "lat": 37.39578618, "lon": 126.9516651, "node_id": 310 },
    "178.0": { "lat": 37.39590735, "lon":126.9516198, "node_id": 305 },
    "179.0": { "lat": 37.39628045, "lon": 126.9514568, "node_id": 294 },
   "180": { "lat": 37.39582225,"lon": 126.9501238,"node_id": 4},
    "181": { "lat": 37.39571059,"lon": 126.9498001,"node_id": 3},
  "182": { "lat": 37.39534546,"lon": 126.948807,"node_id": 298},
    "183": { "lat": 37.39528057,"lon": 126.9486858,"node_id": 297},
    "184": { "lat": 37.39515569,"lon": 126.9487692,"node_id": 296},
     "185": { "lat": 37.39486358,"lon": 126.9489419,"node_id": 295},
    "end": { "lat": 37.39361271, "lon": 126.9496219, "node_id": 1 },
}
map_center = [37.393338, 126.957385]

# --------------------------------------------------------------------------------
# üü¢ Î™®Îì† ÎÖ∏Îìú ÌÇ§Î•º Ìè¨Ìï®ÌïòÎäî ÏàúÏÑú Î¶¨Ïä§Ìä∏ Ï†ïÏùò
# --------------------------------------------------------------------------------
# ÎùºÏù¥ÎçîÍ∞Ä 'start'Î∂ÄÌÑ∞ 'end'ÍπåÏßÄ, Î≤àÌò∏ Îß§Í≤®ÏßÑ Î™®Îì† Ï§ëÍ∞Ñ ÎÖ∏ÎìúÏôÄ 
# ÌîΩÏóÖ/Î∞∞Îã¨ ÏßÄÏ†êÏùÑ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Î∞©Î¨∏ÌïòÎäî Í≤ΩÎ°úÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.

all_node_keys = [
    "start", "1.0", "2.0", "3.0", "4.0", "5.0", "6.0", "7.0", "8.0", "9.0",
    "10.0", "11.0", "pickup1", "pickup2", "14.0", "15.0", "16.0", "17.0",
    "19.0", "20.0", "21.0", "22.0", "23.0", "24.0", "25.0", "26.0", "27.0",
    "28.0", "30.0", "31.0", "32.0", "33.0",
    "34.0", "35.0", "36.0", "37.0", "38.0", "39.0", "40.0", "41.0",
    "42.0", "43.0", "44.0", "45.0", "46.0", "deliver1", "48.0", "49.0",
    "50.0", "51.0", "52.0", "53.0", "54.0", "55.0", "56.0", "57.0",
    "58.0", "59.0", "60.0", "61.0", "62.0", "63.0", "64.0", "65.0",
    "66.0", "67.0", "68.0", "69.0", "70.0", "71.0", "73.0",
    "74.0", "75.0", "76.0", "77.0", "78.0", "79.0", "80.0", "81.0",
    "82.0", "83.0", "84.0", "85.0", "86.0", "pickup3", "pickup4", "pickup5",
    "90.0", "91.0", "92.0", "93.0", "94.0", "95.0", "deliver2", "97.0",
    "98.0", "99.0", "101.0", "102.0", "103.0", "104.0",
    "105.0", "106.0", "107.0", "108.0", "109.0", "110.0", "111.0",
    "112.0", "113.0", "114.0", "115.0", "116.0", "117.0", "118.0",
    "119.0", "121.0", "122.0", "123.0", "deliver3", "125.0",
    "126.0", "127.0", "128.0", "129.0", "130.0", "131.0", "132.0",
    "133.0", "134.0", "135.0", "136.0", "137.0", "139.0",
    "140.0", "deliver4", "142.0", "143.0", "144.0", "145.0", "146.0", "147.0", "148.0", "149.0", "150.0", "151.0", "152.0", "153.0", "154.0",
    "155.0", "156.0", "157.0", "158.0", "159.0", "160.0", "161.0", "162",
    "163", "164", "165", "166", "167", "168", "169.0", "170.0", "171.0",
    "172.0", "173.0", "deliver5", "175.0", "176.0", "177.0", "178.0",
    "179.0", "180", "181", "182", "183", "184", "185", "end"
]

# Î™®Îì† ÎÖ∏ÎìúÎ•º ÏàúÏÑúÎåÄÎ°ú Ìè¨Ìï®ÌïòÎäî Í≤ΩÎ°ú Ï¢åÌëú Î¶¨Ïä§Ìä∏ (ÎèÑÎ°úÎßù Ï§ÄÏàò)
compliant_route_coords = [
    [nodes[k]["lat"], nodes[k]["lon"]] 
    for k in all_node_keys
]

# RRI ÏÉÅÏàòÎäî Í≥ÑÏÇ∞ Î∏îÎ°ù Ïô∏Î∂ÄÏóê Ï†ïÏùò
RRI_THRESHOLD_risk = 50
RRI_THRESHOLD_Highrisk = 50
W_RRI_BEHAVIOR = 0.5; W_ACCIDENT_HISTORY = 0.3; W_DELIVER_CONTEXT = 0.2

# Í∞ÄÏÉÅ RRI ÏûÖÎ†• Îç∞Ïù¥ÌÑ∞
sim_data = {'current_speed_kph': 50, 'simulated_rri_sensor': 15.0, 'accident_time_sec_normalized': 3.97}
compliant_time = 16.1; compliant_avg_risk = 25

# RRI Í≥ÑÏÇ∞ Ìï®Ïàò (Ïù¥Ï†Ñ Îã®Í≥ÑÏóêÏÑú Ï†ïÏùòÎê®)
def normalize_to_rri_scale(value, max_expected_value, min_rri=12.0, max_rri=16.0):
    normalized_0_1 = np.clip(value / max_expected_value, 0, 1)
    rri_scaled = min_rri + (max_rri - min_rri) * normalized_0_1
    return rri_scaled

def calculate_composite_risk(data):
    max_expected_speed = 50
    risk_speed = normalize_to_rri_scale(data['current_speed_kph'], max_expected_speed)
    risk_accident = data['accident_time_sec_normalized']
    risk_rri_behavior = data['simulated_rri_sensor']
    weighted_sum = (W_RRI_BEHAVIOR * risk_rri_behavior + W_ACCIDENT_HISTORY * risk_accident + W_DELIVER_CONTEXT * risk_speed)
    total_weight = W_RRI_BEHAVIOR + W_ACCIDENT_HISTORY + W_DELIVER_CONTEXT
    risk_total = weighted_sum / total_weight
    return risk_total

def assign_grade_color(risk_score):
    if risk_score < 50 : return "ÏúÑÌóò(risk)", "orange"
    else: return "Í≥†ÏúÑÌóò(Highrisk)", "red"


# Í≥ÑÏÇ∞ Ïã§Ìñâ Î∞è Îì±Í∏â Í≤∞Ï†ï
calculated_risk_total = calculate_composite_risk(sim_data)
risk_grade_text, risk_color = assign_grade_color(calculated_risk_total)
rider_current_lat = nodes["83.0"]["lat"]
rider_current_lon = nodes["83.0"]["lon"]


# ====================================================================
# B. Folium ÏßÄÎèÑ ÌÜµÌï© (M Í∞ùÏ≤¥Îäî Îã® Ìïú Î≤àÎßå Ï†ïÏùò/ÏÇ¨Ïö©)
# ====================================================================

# 1. ÏßÄÎèÑ Í∞ùÏ≤¥ ÏÉùÏÑ± (MÏùÄ Îã® Ìïú Î≤àÎßå Ï†ïÏùò)
m = folium.Map(
    location=map_center,
    zoom_start=14, # Ï§å Î†àÎ≤® Ï°∞Ï†ï
    tiles='cartodbpositron'
)

import folium
from folium import LayerControl, TileLayer

# (m = folium.Map(...) Í∞ùÏ≤¥Í∞Ä Ïù¥ÎØ∏ Ï†ïÏùòÎêòÏóàÎã§Í≥† Í∞ÄÏ†ïÌïòÍ≥†, m Í∞ùÏ≤¥Î•º Îã§Ïãú ÏÉùÏÑ±Ìï©ÎãàÎã§.)

# 1. ÏßÄÎèÑ Í∞ùÏ≤¥ ÏÉùÏÑ± (Ï¥àÍ∏∞ ÌÉÄÏùºÏÖãÏùÄ Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ïÌïòÍ±∞ÎÇò ÎπÑÏõåÎë°ÎãàÎã§.)
m = folium.Map(
    location=map_center, 
    zoom_start=15, 
    tiles='cartodbpositron' # ÏûÑÏãú Í∏∞Î≥∏ ÌÉÄÏùºÏÖã ÏÑ§Ï†ï
)

# 2. TileLayer Ï†ïÏùò Î∞è Ï∂îÍ∞Ä (Stamen TerrainÏùÑ Ï≤´ Î∞∞Í≤Ω ÏßÄÎèÑÎ°ú Î™ÖÏãú)

# 2) OpenStreetMap (Í∏∞Î≥∏ ÏßÄÎèÑ)
TileLayer(
    'openstreetmap', 
    name='Í∏∞Î≥∏ ÏßÄÎèÑ (OpenStreetMap)',
    attr='¬© OpenStreetMap contributors',
    overlay=False, 
    control=True,
    show=True 
).add_to(m)

# 3) Esri World Imagery (ÏúÑÏÑ± ÏßÄÎèÑ)
TileLayer(
    tiles='https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    attr='Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
    name='Esri ÏúÑÏÑ± ÏßÄÎèÑ (Í≥†ÌôîÏßà)',
    overlay=False, 
    control=True,
    show=False # Ï≤òÏùåÏóêÎäî Î≥¥Ïù¥ÏßÄ ÏïäÎèÑÎ°ù ÏÑ§Ï†ï
).add_to(m)

# ÌòÑÏû¨ ÎùºÏù¥Îçî ÏúÑÏπòÏôÄ Îã§Ïùå Î™©Ìëú ÏßÄÏ†ê ÏÑ§Ï†ï (ÏãúÎÆ¨Î†àÏù¥ÏÖò Ï¥àÍ∏∞Í∞í)

next_target_lat = compliant_route_coords[1][0] # ÏïàÏ†Ñ Í≤ΩÎ°úÏùò Ï≤´ Î≤àÏß∏ ÌîΩÏóÖÏßÄ
next_target_lon = compliant_route_coords[1][1] # ÏïàÏ†Ñ Í≤ΩÎ°úÏùò Ï≤´ Î≤àÏß∏ ÌîΩÏóÖÏßÄ


# ÎàÑÎùΩÎêú Í±∞Î¶¨ Î∞è Î∞©ÏúÑ Í≥ÑÏÇ∞ Ìï®Ïàò Ï∂îÍ∞Ä (ÌïòÎ≤ÑÏÇ¨Ïù∏ Í≥µÏãù)
def calculate_distance(lat1, lon1, lat2, lon2):
    R = 6371 # ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (km)
    lat1_rad = math.radians(lat1)
    lon1_rad = math.radians(lon1)
    lat2_rad = math.radians(lat2)
    lon2_rad = math.radians(lon2)

    dlon = lon2_rad - lon1_rad
    dlat = lat2_rad - lat1_rad

    a = math.sin(dlat / 2)**2 + math.cos(lat1_rad) * math.cos(lat2_rad) * math.sin(dlon / 2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    distance = R * c
    return distance

def calculate_bearing(lat1, lon1, lat2, lon2):
    # Í∞ÅÎèÑÎ•º ÎùºÎîîÏïàÏúºÎ°ú Î≥ÄÌôò
    lat1_rad = math.radians(lat1)
    lon1_rad = math.radians(lon1)
    lat2_rad = math.radians(lat2)
    lon2_rad = math.radians(lon2)

    dLon = lon2_rad - lon1_rad

    y = math.sin(dLon) * math.cos(lat2_rad)
    x = math.cos(lat1_rad) * math.sin(lat2_rad) - math.sin(lat1_rad) * math.cos(lat2_rad) * math.cos(dLon)
    
    # ÏïÑÌÅ¨ÌÉÑÏ††Ìä∏2 Ìï®ÏàòÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Î∞©ÏúÑÍ∞Å Í≥ÑÏÇ∞
    initial_bearing = math.atan2(y, x)
    
    # ÎùºÎîîÏïàÏùÑ ÎèÑÎ°ú Î≥ÄÌôòÌïòÍ≥†, 0~360ÎèÑ Î≤îÏúÑÎ°ú Ï°∞Ï†ï
    compass_bearing = (initial_bearing + 360) % 360
    return compass_bearing

# --- ÏÉàÎ°úÏö¥ Î≥ÄÏàò Í≥ÑÏÇ∞ ---
remaining_distance_km = calculate_distance(rider_current_lat, rider_current_lon, next_target_lat, next_target_lon)
current_bearing_deg = calculate_bearing(rider_current_lat, rider_current_lon, next_target_lat, next_target_lon)



# üöß Í≥ºÏÜçÎ∞©ÏßÄÌÑ± ÎßàÏª§ Ï∂îÍ∞Ä (Î°úÏª¨ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
hump_locations = [
    
    [37.38863274, 126.9599509],
    [37.39122247, 126.9550854],
    [37.39102025, 126.9524532]
]
for lat, lon in hump_locations:
    folium.Marker(
        location=[lat, lon],
        popup="Í≥ºÏÜçÎ∞©ÏßÄÌÑ± (Hump) Íµ¨Í∞Ñ",
        icon=folium.CustomIcon(
            # üü¢ [ÏàòÏ†ï] Î°úÏª¨ Ïù¥ÎØ∏ÏßÄÏùò ÏÉÅÎåÄ Í≤ΩÎ°ú ÏßÄÏ†ï (images Ìè¥Îçî ÎÇ¥ ÌååÏùº)
            icon_image='KR_road_sign_129.svg.png',
            icon_size=(25, 25),
            icon_anchor=(20, 20)
        )
    ).add_to(m)

    # 30ÏÜçÎèÑ ÌëúÏßÄÌåê ÎßàÏª§ Ï∂îÍ∞Ä (Î°úÏª¨ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
velocity_locations = [
    
    [37.39395993, 126.9506615],
    [37.39506083, 126.95128]
]
for lat, lon in velocity_locations:
    folium.Marker(
        location=[lat, lon],
        popup="Ïñ¥Î¶∞Ïù¥Î≥¥Ìò∏Íµ¨Ïó≠ ÏÜçÎèÑ 30 Íµ¨Í∞Ñ",
        icon=folium.CustomIcon(
            # üü¢ [ÏàòÏ†ï] Î°úÏª¨ Ïù¥ÎØ∏ÏßÄÏùò ÏÉÅÎåÄ Í≤ΩÎ°ú ÏßÄÏ†ï (images Ìè¥Îçî ÎÇ¥ ÌååÏùº)
            icon_image='ÏÜçÎèÑ30ÌëúÏßÄÌåê.png',
            icon_size=(30, 30),
            icon_anchor=(25, 25)
        )
    ).add_to(m)



# 3. ÎßàÏª§ Ï∂îÍ∞Ä (ÌîΩÏóÖ, Î∞∞Îã¨, Ï∂úÎ∞ú/ÎèÑÏ∞©)

# üö© Ï∂úÎ∞úÏßÄ/ÎèÑÏ∞©ÏßÄ ÎßàÏª§
folium.Marker(location=[nodes["start"]["lat"], nodes["start"]["lon"]], popup="Ï∂úÎ∞úÏßÄ",
              icon=folium.Icon(color="blue", icon="play", prefix='fa')).add_to(m)
folium.Marker(location=[nodes["end"]["lat"], nodes["end"]["lon"]], popup="ÎèÑÏ∞©ÏßÄ",
              icon=folium.Icon(color="red", icon="flag-checkered", prefix='fa')).add_to(m)

# üç¥ ÌîΩÏóÖÏßÄ ÎßàÏª§ (utensils, lightred/orange)
folium.Marker(
    location=[nodes["pickup1"]["lat"], nodes["pickup1"]["lon"]],
    popup="A,B ÌîΩÏóÖÏôÑÎ£å",
    icon=folium.Icon(color="orange", icon="utensils", prefix='fa')
).add_to(m)

folium.Marker(
    location=[nodes["pickup2"]["lat"], nodes["pickup2"]["lon"]],
    popup="A,B ÌîΩÏóÖÏôÑÎ£å",
    icon=folium.Icon(color="orange", icon="utensils", prefix='fa')
).add_to(m)

folium.Marker(
    location=[nodes["pickup3"]["lat"], nodes["pickup3"]["lon"]],
    popup="C,D,E ÌîΩÏóÖÏôÑÎ£å",
    icon=folium.Icon(color="orange", icon="utensils", prefix='fa')
).add_to(m)

folium.Marker(
    location=[nodes["pickup4"]["lat"], nodes["pickup4"]["lon"]],
    popup="C,D,E ÌîΩÏóÖÏôÑÎ£å",
    icon=folium.Icon(color="orange", icon="utensils", prefix='fa')
).add_to(m)

folium.Marker(
    location=[nodes["pickup5"]["lat"], nodes["pickup5"]["lon"]],
    popup="C,D,E ÌîΩÏóÖÏôÑÎ£å",
    icon=folium.Icon(color="orange", icon="utensils", prefix='fa')
).add_to(m)


# ‚úÖ Î∞∞Îã¨ÏßÄ ÎßàÏª§ (ÏôÑÎ£å: green check-circle, ÏòàÏ†ï: cadetblue clock)
for i in range(1, 6):
    node_key = f"deliver{i}"
    popup_text = ["B Î∞∞Îã¨ÏôÑÎ£å", "E Î∞∞Îã¨ÏôÑÎ£å", "D Î∞∞Îã¨ÏòàÏ†ï", "A Î∞∞Îã¨ÏòàÏ†ï", "C Î∞∞Îã¨ÏòàÏ†ï"][i-1]
    
    color = "green" if i in [1, 2] else "cadetblue"
    icon_name = "check-circle" if i in [1, 2] else "clock"
    
    folium.Marker(location=[nodes[node_key]["lat"], nodes[node_key]["lon"]], 
                  popup=popup_text,
                  icon=folium.Icon(color=color, icon=icon_name, prefix='fa')).add_to(m)

# üî¥ ÌòÑÏû¨ ÎùºÏù¥Îçî ÏúÑÏπò (RRI Î∞òÏòÅ)
folium.CircleMarker(
    location=[rider_current_lat, rider_current_lon],
    
    color='red', 
    fill=True,
    fill_color='red',
    fill_opacity=0.6,# ÌòÑÏû¨ Ï£ºÌñâ Ï§ëÏûÑÏùÑ ÎÇòÌÉÄÎÇ¥Îäî ÏÉâÏÉÅ
    popup=f"ÌòÑÏû¨ ÎùºÏù¥Îçî ÏúÑÏπò\nÎ≥µÌï© RRI: {calculated_risk_total:.2f} ({risk_grade_text})",
    tooltip=f"ÌòÑÏû¨ ÏúÑÏπò: {risk_grade_text} Îì±Í∏â"
).add_to(m)

folium.Marker(
    location=[rider_current_lat, rider_current_lon],
    icon=folium.Icon(color="red", icon='motorcycle', prefix='fa'),
    popup=f"ÌòÑÏû¨ RRI: {calculated_risk_total:.2f}",
    tooltip="ÎùºÏù¥Îçî ÌòÑÏúÑÏπò"
).add_to(m)

# C. Ï£ºÌñâ Ï§ë Í≤ΩÎ°ú ÌëúÌòÑÏùÑ ÏúÑÌïú Í≤ΩÎ°ú Î∂ÑÎ¶¨ Î°úÏßÅ

# 1. ÎùºÏù¥ÎçîÏùò ÌòÑÏû¨ ÏúÑÏπòÍ∞Ä Ïñ¥Îîî ÎÖ∏ÎìúÏóê Í∞ÄÍπåÏö¥ÏßÄ Ï∞æÏïÑÏïº ÌïòÏßÄÎßå, 
#    Í∞ÑÎã®ÌïòÍ≤å ÌòÑÏû¨ ÏΩîÎìúÍ∞Ä ÏßÄÎèÑ Ï§ëÏïôÏóê ÎßàÏª§Î•º Ï∞çÏúºÎØÄÎ°ú, 
#    ÏãúÎÆ¨Î†àÏù¥ÏÖò Î™©Ï†ÅÏúºÎ°ú 'start'Î∂ÄÌÑ∞ ÌäπÏ†ï ÎÖ∏ÎìúÍπåÏßÄÎ•º 'Ï£ºÌñâ ÏôÑÎ£å'Î°ú Í∞ÄÏ†ïÌï©ÎãàÎã§.

# üü¢ [ÏàòÏ†ï] ÏïÑÎûò Îëò Ï§ë Ìïú Í∞ÄÏßÄ Î∞©Î≤ïÏúºÎ°ú Ï†ïÏàò Ïù∏Îç±Ïä§Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.

# Î∞©Î≤ï 1: ÌäπÏ†ï ÎÖ∏Îìú ÌÇ§Ïùò Ïù∏Îç±Ïä§Î•º ÏßÅÏ†ë Ï∞æÏïÑÏÑú ÏÇ¨Ïö©
# ÏòàÎ•º Îì§Ïñ¥, "20.0" ÎÖ∏ÎìúÍπåÏßÄÏùò Í≤ΩÎ°úÎ•º ÏßÄÎÇòÏò® Í≤ÉÏúºÎ°ú Í∞ÄÏ†ïÌïòÎ†§Î©¥:
# current_node_key = "20.0"
# current_node_index = all_node_keys.index(current_node_key) # 'all_node_keys' Î¶¨Ïä§Ìä∏ÏóêÏÑú Ìï¥Îãπ ÌÇ§Ïùò Ïù∏Îç±Ïä§Î•º Ï∞æÏäµÎãàÎã§.

# ÏòàÎ•º Îì§Ïñ¥, "83.0" ÎÖ∏ÎìúÍπåÏßÄÏùò Í≤ΩÎ°úÎ•º ÏßÄÎÇòÏò® Í≤ÉÏúºÎ°ú Í∞ÄÏ†ïÌïòÎ†§Î©¥:
current_node_key = "83.0" # üî¥ ÏõêÌïòÎäî ÎÖ∏Îìú ÌÇ§Î•º Ïó¨Í∏∞Ïóê ÏûÖÎ†•ÌïòÏÑ∏Ïöî.
current_node_index = all_node_keys.index(current_node_key) # 'all_node_keys' Î¶¨Ïä§Ìä∏ÏóêÏÑú Ìï¥Îãπ ÌÇ§Ïùò Ïù∏Îç±Ïä§Î•º Ï∞æÏäµÎãàÎã§.


# Î∞©Î≤ï 2: Îã®ÏàúÌûà Ï†ïÏàò Í∞íÏùÑ ÏßÅÏ†ë ÏßÄÏ†ï (ÏòàÏãú)
# current_node_index = 20 # ÏòàÎ•º Îì§Ïñ¥, 'start'Î∂ÄÌÑ∞ 20Î≤àÏß∏ ÎÖ∏ÎìúÍπåÏßÄÎ•º Ï£ºÌñâ ÏôÑÎ£åÎ°ú Í∞ÄÏ†ï (0Î∂ÄÌÑ∞ ÏãúÏûë)


# 2. Í≤ΩÎ°ú Î∂ÑÎ¶¨
passed_route_coords = compliant_route_coords[:current_node_index + 1] # ÏßÄÎÇòÏò® Í≤ΩÎ°ú
remaining_route_coords = compliant_route_coords[current_node_index:] # ÎÇ®ÏùÄ Í≤ΩÎ°ú

# 4. Í≤ΩÎ°ú PolyLine Ï∂îÍ∞Ä (ÏΩîÎìú ÎÇ¥ 4. Í≤ΩÎ°ú PolyLine Ï∂îÍ∞Ä ÏÑπÏÖò ÎåÄÏ≤¥)

# üü¢ [Ï∂îÍ∞Ä] ÏßÄÎÇòÏò® Í≤ΩÎ°ú (ÏôÑÎ£å)
folium.PolyLine(
    passed_route_coords,
    color="darkgreen", # Ïù¥ÎØ∏ Ï£ºÌñâ ÏôÑÎ£åÎêú Í≤ΩÎ°úÎäî ÏßÑÌïú ÎÖπÏÉâ
    weight=6,
    opacity=0.8,
    dash_array="5, 5",
    name='Ï£ºÌñâ ÏôÑÎ£å Í≤ΩÎ°ú',
    tooltip=f"Ï£ºÌñâ ÏôÑÎ£å Í≤ΩÎ°ú"
).add_to(m)

# üü¢ [ÏàòÏ†ï] ÎÇ®ÏùÄ Í≤ΩÎ°ú (ÏòàÏ†ï)
folium.PolyLine(
    remaining_route_coords,
    color="blue",
    weight=5,
    opacity=0.8,
    dash_array="5, 5", # Ï†êÏÑ†(dash_array) Ïú†ÏßÄ
    name='ÎÇ®ÏùÄ Í≤ΩÎ°ú', 
    tooltip=f"ÎÇ®ÏùÄ Í≤ΩÎ°ú"
).add_to(m)
# 5. Ïª®Ìä∏Î°§ Î∞è ÌîåÎü¨Í∑∏Ïù∏ Ï∂îÍ∞Ä

# LocateControl (ÌòÑÏû¨ ÏúÑÏπò Ï∂îÏ†Å Í∏∞Îä•, Ïã§Ï†ú GPS ÏÇ¨Ïö©)
LocateControl(auto_start=False, strings={'title': "ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥Îèô"}, icon='fa-crosshairs').add_to(m)

# LayerControl (Î∞∞Í≤Ω ÏßÄÎèÑ Î∞è Í≤ΩÎ°ú ÏÑ†ÌÉù Í∏∞Îä•)
LayerControl(collapsed=True).add_to(m) 


# 6. ÏµúÏ¢Ö Ï∂úÎ†•
#display(m)


# ====================================================================
# B. CSS Î∞è HTML Íµ¨Ï°∞ Ï†ïÏùò (ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î™®Îìú)
# ====================================================================

# --- 1. CSS Ï†ïÏùò (Google Maps Dark Theme Î™®ÏÇ¨) ---
css_styles = """
<style>
    .dashboard-container {font-family: 'Roboto', 'Arial', sans-serif; display: flex; flex-direction: column; gap: 15px; background-color: #f0f2f5; max-width: 100%; position: relative;}
    /* 1. ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò ÏÉÅÎã®Î∞î (Ïñ¥ÎëêÏö¥ Î∞∞Í≤Ω) */
    .nav-header {
        display: flex; justify-content: space-around; align-items: center;
        background-color: #202020; 
        color: #e0e0e0; 
        padding: 10px 15px;
        font-size: 0.9em;
    }
    .nav-item {text-align: center; flex: 1; line-height: 1.2;}
    .nav-item-value {font-size: 1.3em; font-weight: bold; color: #4285f4;} /* Google Blue Í∞ïÏ°∞ */
    
     
    /* 2. ÎÑ§Î™®ÌïòÎÇòÎçî */
    .deliver-status {
        position: absolute; /* Ï†àÎåÄ ÏúÑÏπò */
        bottom: 40px; /* ÌïòÎã®ÏóêÏÑú ÎùÑÏõÄ */
        left: 80%; /* Ï§ëÏïô Ï†ïÎ†¨ ÏãúÏûë */
        transform: translateX(-80%); /* Ï†ïÌôïÌûà Ï§ëÏïôÏúºÎ°ú Ïù¥Îèô */
        background-color: white; 
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); 
        padding: 12px 20px; 
        font-size: 1.1em;
        font-weight: bold;
        color: #333;
        border-left: 5px solid #dc3545; /* ÏúÑÌóòÎèÑ Îπ®Í∞ÑÏÉâ Î∞î Í∞ïÏ°∞ */
        z-index: 1000; /* ÏßÄÎèÑ ÏúÑÏóê ÌëúÏãú */
    }
    .deliver-status span {
        font-weight: bold;
        color: #dc3545; /* ÏúÑÌóòÎèÑ Í∞íÏùÄ Îπ®Í∞ÑÏÉâÏúºÎ°ú */
    }
    #map-container {
        width: 100%;
        height: 500px; 
    }
</style>

   
"""

html_dashboard = f"""
{css_styles}
<div class="dashboard-container">
    <div class="nav-header">
        <div class="nav-item">Îã§Ïùå Î∞∞Îã¨ÏßÄ<br><span class="nav-item-value">Í≥µÏûëÎ∂ÄÏòÅÏïÑÌååÌä∏ 308</span></div>
        <div class="nav-item">Îã§Ïùå Î∞∞Îã¨ÏßÄÍπåÏßÄ ÎèÑÏ∞©ÏòàÏ†ïÏãúÍ∞Ñ<br><span class="nav-item-value">9:58</span></div>
        <div class="nav-item">Îã§Ïùå Î∞∞Îã¨ÏßÄÍπåÏßÄ ÎÇ®ÏùÄ ÏãúÍ∞Ñ<br><span class="nav-item-value">~{(compliant_time/60):.1f}Î∂Ñ</span></div>
        <div class="nav-item">ÎÇ®ÏùÄ Í±∞Î¶¨<br><span class="nav-item-value">{remaining_distance_km:.2f} km</span></div>
        <div class="nav-item">Ïã§ÏãúÍ∞Ñ Ï£ºÌñâ ÏÜçÎèÑ<br><span class="nav-item-value">50 km/h</span></div>
        <div class="nav-item">ÌòÑÏû¨ ÎÇ®ÏùÄ Î∞∞Îã¨ Í±¥Ïàò<br><span class="nav-item-value">3Í±¥</span></div>
    </div>
    
    <div id="map-container"></div>  
    
"""


# 5. ÏµúÏ¢Ö Ï∂úÎ†•
map_html = m._repr_html_()
final_html_output = html_dashboard.replace('<div id="map-container"></div>', f'<div id="map-container">{map_html}</div>')

display(HTML(final_html_output))

# (Ïù¥Ï†Ñ ÏΩîÎìú ÏÉùÎûµ: ÏßÄÎèÑ Í∞ùÏ≤¥ 'm' Ï†ïÏùò, ÎßàÏª§ Î∞è Í≤ΩÎ°ú Ï∂îÍ∞Ä, HTML ÎåÄÏãúÎ≥¥Îìú Íµ¨Ï°∞Ìôî ÏôÑÎ£å ÌõÑ)


# üü¢ [Ï∂îÍ∞Ä] ÏµúÏ¢Ö HTML ÎÇ¥Ïö©ÏùÑ ÌååÏùºÎ°ú Ï†ÄÏû•
with open("obey_rider_rri_dashboard.html", "w", encoding="utf-8") as f:
    f.write(final_html_output)

